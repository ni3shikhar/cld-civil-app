# GitHub Actions Deployment Pipeline for Contoso Civil App
# Deploys infrastructure and application to Azure

name: Deploy to Azure

on:
  workflow_run:
    workflows: ["Build and Push Images"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_infra:
        description: 'Deploy infrastructure'
        required: false
        default: true
        type: boolean
      deploy_database:
        description: 'Initialize database schema'
        required: false
        default: false
        type: boolean

env:
  AZURE_SUBSCRIPTION: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  LOCATION: 'westus2'

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    env:
      SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
      SQL_ADMIN_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    
    outputs:
      acr_login_server: ${{ steps.deploy.outputs.acrLoginServer }}
      api_url: ${{ steps.deploy.outputs.apiGatewayUrl }}
      frontend_url: ${{ steps.deploy.outputs.frontendUrl }}
      sql_server: ${{ steps.deploy.outputs.sqlServerFqdn }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Environment Variables
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "resource_group=${{ secrets.RESOURCE_GROUP }}" >> $GITHUB_OUTPUT

      - name: Validate Required Secrets
        run: |
          echo "Validating required secrets..."
          echo "SQL_ADMIN_PASSWORD length: ${#SQL_ADMIN_PASSWORD}"
          echo "SQL_ADMIN_LOGIN length: ${#SQL_ADMIN_LOGIN}"
          echo "JWT_SECRET length: ${#JWT_SECRET}"
          
          if [ -z "$SQL_ADMIN_PASSWORD" ] || [ ${#SQL_ADMIN_PASSWORD} -lt 8 ]; then
            echo "::error::SQL_ADMIN_PASSWORD is missing or too short (min 8 chars)"
            exit 1
          fi
          
          if [ -z "$SQL_ADMIN_LOGIN" ]; then
            echo "::warning::SQL_ADMIN_LOGIN not set, will use default 'sqladmin'"
          fi
          
          if [ -z "$JWT_SECRET" ]; then
            echo "::warning::JWT_SECRET not set"
          fi
          
          echo "Secrets validation passed"

      - name: Create Resource Group
        run: |
          az group create \
            --name "${{ secrets.RESOURCE_GROUP }}" \
            --location ${{ env.LOCATION }}

      - name: Deploy Bicep Template
        id: deploy
        if: github.event.inputs.deploy_infra != 'false'
        env:
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          DEPLOY_RG: ${{ secrets.RESOURCE_GROUP }}
          DEPLOY_LOCATION: ${{ env.LOCATION }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Use default login if not set
          SQL_LOGIN="${SQL_ADMIN_LOGIN:-sqladmin}"
          
          # Debug: print password length (not value)
          echo "Password length: ${#SQL_ADMIN_PASSWORD}"
          echo "Login: $SQL_LOGIN"
          
          # Create parameters JSON file to handle special characters
          cat > params.json << 'PARAMS_EOF'
          {
            "environment": { "value": "PLACEHOLDER_ENV" },
            "location": { "value": "PLACEHOLDER_LOC" },
            "sqlAdminLogin": { "value": "PLACEHOLDER_LOGIN" },
            "sqlAdminPassword": { "value": "PLACEHOLDER_PWD" },
            "jwtSecret": { "value": "PLACEHOLDER_JWT" }
          }
          PARAMS_EOF
          
          # Replace placeholders with actual values using jq
          jq --arg env "$DEPLOY_ENV" \
             --arg loc "$DEPLOY_LOCATION" \
             --arg login "$SQL_LOGIN" \
             --arg pwd "$SQL_ADMIN_PASSWORD" \
             --arg jwt "$JWT_SECRET" \
             '.environment.value = $env | .location.value = $loc | .sqlAdminLogin.value = $login | .sqlAdminPassword.value = $pwd | .jwtSecret.value = $jwt' \
             params.json > params_final.json
          
          OUTPUT=$(az deployment group create \
            --name "deployment-$RUN_ID" \
            --resource-group "$DEPLOY_RG" \
            --template-file infra/main.bicep \
            --parameters @params_final.json \
            --output json)
          
          rm -f params.json params_final.json
          
          echo "acrLoginServer=$(echo $OUTPUT | jq -r '.properties.outputs.acrLoginServer.value')" >> $GITHUB_OUTPUT
          echo "apiGatewayUrl=$(echo $OUTPUT | jq -r '.properties.outputs.apiGatewayUrl.value')" >> $GITHUB_OUTPUT
          echo "frontendUrl=$(echo $OUTPUT | jq -r '.properties.outputs.frontendUrl.value')" >> $GITHUB_OUTPUT
          echo "sqlServerFqdn=$(echo $OUTPUT | jq -r '.properties.outputs.sqlServerFqdn.value')" >> $GITHUB_OUTPUT

      - name: Initialize Database
        if: github.event.inputs.deploy_database == 'true'
        env:
          SQL_SERVER_OUTPUT: ${{ steps.deploy.outputs.sqlServerFqdn }}
          SQLCMDPASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
          RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
        run: |
          # Get SQL server FQDN - from deploy output or query Azure
          if [ -n "$SQL_SERVER_OUTPUT" ]; then
            SQL_SERVER="$SQL_SERVER_OUTPUT"
          else
            echo "Deploy output empty, querying Azure for SQL server..."
            SQL_SERVER=$(az sql server list -g "$RESOURCE_GROUP" --query "[0].fullyQualifiedDomainName" -o tsv)
          fi
          
          echo "SQL Server: $SQL_SERVER"
          
          if [ -z "$SQL_SERVER" ]; then
            echo "::error::Could not determine SQL Server FQDN"
            exit 1
          fi
          
          # Get SQL server name (without domain)
          SQL_SERVER_NAME=$(echo "$SQL_SERVER" | cut -d'.' -f1)
          
          # Get runner's public IP and add to SQL firewall
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Adding runner IP $RUNNER_IP to SQL firewall..."
          az sql server firewall-rule create \
            -g "$RESOURCE_GROUP" \
            -s "$SQL_SERVER_NAME" \
            -n "GitHubRunner-${{ github.run_id }}" \
            --start-ip-address "$RUNNER_IP" \
            --end-ip-address "$RUNNER_IP"
          
          # Install sqlcmd
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
          
          # Use default login if not set (SQL_ADMIN_LOGIN from job-level env)
          SQL_LOGIN="${SQL_ADMIN_LOGIN:-sqladmin}"
          
          # Azure SQL doesn't support CREATE DATABASE or USE statements
          # Remove lines 4-10 (DB creation and USE blocks) - connect directly to the database (created by Bicep)
          tail -n +11 database/schema.sql > database/azure-schema.sql
          
          # Run schema using SQLCMDPASSWORD env var (avoids shell escaping issues)
          /opt/mssql-tools18/bin/sqlcmd \
            -S "$SQL_SERVER" \
            -U "$SQL_LOGIN" \
            -d ContosoCivilApp \
            -i database/azure-schema.sql \
            -C -b
          
          # Clean up firewall rule
          echo "Removing runner IP from SQL firewall..."
          az sql server firewall-rule delete \
            -g "$RESOURCE_GROUP" \
            -s "$SQL_SERVER_NAME" \
            -n "GitHubRunner-${{ github.run_id }}"

  deploy-containers:
    name: Build & Deploy Container Apps
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    env:
      ACR_LOGIN_SERVER: ${{ needs.deploy-infrastructure.outputs.acr_login_server }}
      IMAGE_TAG: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: |
          echo "Logging into ACR: $ACR_LOGIN_SERVER"
          az acr login --name $(echo $ACR_LOGIN_SERVER | cut -d'.' -f1)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build and Push Images
        run: |
          echo "Building and pushing images to $ACR_LOGIN_SERVER"
          
          # Build and push frontend
          echo "Building frontend..."
          docker build -f .docker/Dockerfile.frontend -t $ACR_LOGIN_SERVER/frontend:$IMAGE_TAG -t $ACR_LOGIN_SERVER/frontend:latest .
          docker push $ACR_LOGIN_SERVER/frontend:$IMAGE_TAG
          docker push $ACR_LOGIN_SERVER/frontend:latest
          
          # Build and push api-gateway
          echo "Building api-gateway..."
          docker build -f .docker/Dockerfile.api-gateway -t $ACR_LOGIN_SERVER/api-gateway:$IMAGE_TAG -t $ACR_LOGIN_SERVER/api-gateway:latest .
          docker push $ACR_LOGIN_SERVER/api-gateway:$IMAGE_TAG
          docker push $ACR_LOGIN_SERVER/api-gateway:latest
          
          # Build and push backend services
          for service in user-service job-service interview-service application-service; do
            echo "Building $service..."
            docker build -f .docker/Dockerfile.services --build-arg SERVICE_NAME=$service -t $ACR_LOGIN_SERVER/$service:$IMAGE_TAG -t $ACR_LOGIN_SERVER/$service:latest .
            docker push $ACR_LOGIN_SERVER/$service:$IMAGE_TAG
            docker push $ACR_LOGIN_SERVER/$service:latest
          done

      - name: Update Container Apps
        run: |
          # Container app names must match Bicep template (prefix='civil')
          declare -A APP_IMAGES=(
            ["civil-user-service"]="user-service"
            ["civil-job-service"]="job-service"
            ["civil-interview-service"]="interview-service"
            ["civil-app-svc"]="application-service"
            ["civil-api-gateway"]="api-gateway"
            ["civil-frontend"]="frontend"
          )
          
          for app_name in "${!APP_IMAGES[@]}"; do
            image_name="${APP_IMAGES[$app_name]}"
            echo "Updating $app_name with image $image_name..."
            az containerapp update \
              --name "$app_name" \
              --resource-group "${{ secrets.RESOURCE_GROUP }}" \
              --image "$ACR_LOGIN_SERVER/$image_name:$IMAGE_TAG" \
              --output none || echo "Warning: Failed to update $app_name"
          done

      - name: Display Deployment URLs
        run: |
          echo "============================================"
          echo "Deployment Complete!"
          echo "============================================"
          echo "Frontend URL: ${{ needs.deploy-infrastructure.outputs.frontend_url }}"
          echo "API Gateway URL: ${{ needs.deploy-infrastructure.outputs.api_url }}"
          echo "============================================"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-containers]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.deploy-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Apps | ${{ needs.deploy-containers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.deploy-infrastructure.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- API: ${{ needs.deploy-infrastructure.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
