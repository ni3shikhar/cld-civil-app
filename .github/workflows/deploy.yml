# GitHub Actions Deployment Pipeline for Contoso Civil App
# Deploys infrastructure and application to Azure

name: Deploy to Azure

on:
  workflow_run:
    workflows: ["Build and Push Images"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_infra:
        description: 'Deploy infrastructure'
        required: false
        default: true
        type: boolean
      deploy_database:
        description: 'Initialize database schema'
        required: false
        default: false
        type: boolean

env:
  AZURE_SUBSCRIPTION: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  LOCATION: 'westus2'

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    outputs:
      acr_login_server: ${{ steps.deploy.outputs.acrLoginServer }}
      api_url: ${{ steps.deploy.outputs.apiGatewayUrl }}
      frontend_url: ${{ steps.deploy.outputs.frontendUrl }}
      sql_server: ${{ steps.deploy.outputs.sqlServerFqdn }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Environment Variables
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "resource_group=${{ secrets.RESOURCE_GROUP }}" >> $GITHUB_OUTPUT

      - name: Validate Required Secrets
        env:
          SQL_PWD: ${{ secrets.SQL_ADMIN_PASSWORD }}
          SQL_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
          JWT: ${{ secrets.JWT_SECRET }}
        run: |
          echo "Validating required secrets..."
          echo "SQL_ADMIN_PASSWORD length: ${#SQL_PWD}"
          echo "SQL_ADMIN_LOGIN length: ${#SQL_LOGIN}"
          echo "JWT_SECRET length: ${#JWT}"
          
          if [ -z "$SQL_PWD" ] || [ ${#SQL_PWD} -lt 8 ]; then
            echo "::error::SQL_ADMIN_PASSWORD is missing or too short (min 8 chars)"
            exit 1
          fi
          
          if [ -z "$SQL_LOGIN" ]; then
            echo "::warning::SQL_ADMIN_LOGIN not set, will use default 'sqladmin'"
          fi
          
          if [ -z "$JWT" ]; then
            echo "::warning::JWT_SECRET not set"
          fi
          
          echo "Secrets validation passed"

      - name: Create Resource Group
        run: |
          az group create \
            --name "${{ secrets.RESOURCE_GROUP }}" \
            --location ${{ env.LOCATION }}

      - name: Deploy Bicep Template
        id: deploy
        if: github.event.inputs.deploy_infra != 'false'
        env:
          SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SQL_ADMIN_LOGIN_INPUT: ${{ secrets.SQL_ADMIN_LOGIN }}
          DEPLOY_ENV: ${{ steps.env.outputs.environment }}
          DEPLOY_RG: ${{ secrets.RESOURCE_GROUP }}
          DEPLOY_LOCATION: ${{ env.LOCATION }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Use default login if not set
          SQL_ADMIN_LOGIN="${SQL_ADMIN_LOGIN_INPUT:-sqladmin}"
          
          # Debug: print password length (not value)
          echo "Password length: ${#SQL_ADMIN_PASSWORD}"
          echo "Login: $SQL_ADMIN_LOGIN"
          
          # Create parameters JSON file to handle special characters
          cat > params.json << 'PARAMS_EOF'
          {
            "environment": { "value": "PLACEHOLDER_ENV" },
            "location": { "value": "PLACEHOLDER_LOC" },
            "sqlAdminLogin": { "value": "PLACEHOLDER_LOGIN" },
            "sqlAdminPassword": { "value": "PLACEHOLDER_PWD" },
            "jwtSecret": { "value": "PLACEHOLDER_JWT" }
          }
          PARAMS_EOF
          
          # Replace placeholders with actual values using jq
          jq --arg env "$DEPLOY_ENV" \
             --arg loc "$DEPLOY_LOCATION" \
             --arg login "$SQL_ADMIN_LOGIN" \
             --arg pwd "$SQL_ADMIN_PASSWORD" \
             --arg jwt "$JWT_SECRET" \
             '.environment.value = $env | .location.value = $loc | .sqlAdminLogin.value = $login | .sqlAdminPassword.value = $pwd | .jwtSecret.value = $jwt' \
             params.json > params_final.json
          
          OUTPUT=$(az deployment group create \
            --name "deployment-$RUN_ID" \
            --resource-group "$DEPLOY_RG" \
            --template-file infra/main.bicep \
            --parameters @params_final.json \
            --output json)
          
          rm -f params.json params_final.json
          
          echo "acrLoginServer=$(echo $OUTPUT | jq -r '.properties.outputs.acrLoginServer.value')" >> $GITHUB_OUTPUT
          echo "apiGatewayUrl=$(echo $OUTPUT | jq -r '.properties.outputs.apiGatewayUrl.value')" >> $GITHUB_OUTPUT
          echo "frontendUrl=$(echo $OUTPUT | jq -r '.properties.outputs.frontendUrl.value')" >> $GITHUB_OUTPUT
          echo "sqlServerFqdn=$(echo $OUTPUT | jq -r '.properties.outputs.sqlServerFqdn.value')" >> $GITHUB_OUTPUT

      - name: Initialize Database
        if: github.event.inputs.deploy_database == 'true'
        run: |
          # Install sqlcmd
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
          
          # Run schema
          /opt/mssql-tools18/bin/sqlcmd \
            -S ${{ steps.deploy.outputs.sqlServerFqdn }} \
            -U ${{ secrets.SQL_ADMIN_LOGIN }} \
            -P "${{ secrets.SQL_ADMIN_PASSWORD }}" \
            -d ContosoCivilApp \
            -i database/schema.sql \
            -C -b

  deploy-containers:
    name: Deploy Container Apps
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Environment Variables
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "resource_group=rg-contoso-civil-$ENV" >> $GITHUB_OUTPUT

      - name: Update Container Apps
        run: |
          SERVICES=("user-service" "job-service" "interview-service" "application-service" "api-gateway" "frontend")
          
          for service in "${SERVICES[@]}"; do
            echo "Updating contoso-civil-$service..."
            az containerapp update \
              --name "contoso-civil-$service" \
              --resource-group ${{ secrets.RESOURCE_GROUP }} \
              --image "${{ secrets.ACR_LOGIN_SERVER }}/$service:${{ github.sha }}" \
              --output none || echo "Warning: Failed to update $service"
          done

      - name: Display Deployment URLs
        run: |
          echo "============================================"
          echo "Deployment Complete!"
          echo "============================================"
          echo "Frontend URL: ${{ needs.deploy-infrastructure.outputs.frontend_url }}"
          echo "API Gateway URL: ${{ needs.deploy-infrastructure.outputs.api_url }}"
          echo "============================================"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-containers]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.deploy-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Apps | ${{ needs.deploy-containers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.deploy-infrastructure.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- API: ${{ needs.deploy-infrastructure.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
