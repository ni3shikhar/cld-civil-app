# GitHub Actions Build Pipeline for Contoso Civil App
# Builds Docker images and pushes to Azure Container Registry

name: Build and Push Images

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.docker/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main]

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            backend/api-gateway/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Frontend
        working-directory: frontend
        run: npm run build

      - name: Install Backend Dependencies
        run: |
          cd backend/api-gateway && npm ci
          cd ../services/user-service && npm ci
          cd ../job-service && npm ci
          cd ../interview-service && npm ci
          cd ../application-service && npm ci
          cd ../rate-analysis-service && npm ci

      - name: TypeScript Compile Check
        run: |
          cd backend/api-gateway && npx tsc --noEmit
          cd ../services/user-service && npx tsc --noEmit
          cd ../services/job-service && npx tsc --noEmit
          cd ../services/interview-service && npx tsc --noEmit
          cd ../services/application-service && npx tsc --noEmit
          cd ../rate-analysis-service && npx tsc --noEmit
        continue-on-error: true

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Frontend
        run: |
          docker build -f .docker/Dockerfile.frontend -t $REGISTRY/frontend:$IMAGE_TAG -t $REGISTRY/frontend:latest .
          docker push $REGISTRY/frontend:$IMAGE_TAG
          docker push $REGISTRY/frontend:latest

      - name: Build and Push API Gateway
        run: |
          docker build -f .docker/Dockerfile.api-gateway -t $REGISTRY/api-gateway:$IMAGE_TAG -t $REGISTRY/api-gateway:latest .
          docker push $REGISTRY/api-gateway:$IMAGE_TAG
          docker push $REGISTRY/api-gateway:latest

      - name: Build and Push User Service
        run: |
          docker build -f .docker/Dockerfile.services --build-arg SERVICE_NAME=user-service -t $REGISTRY/user-service:$IMAGE_TAG -t $REGISTRY/user-service:latest .
          docker push $REGISTRY/user-service:$IMAGE_TAG
          docker push $REGISTRY/user-service:latest

      - name: Build and Push Job Service
        run: |
          docker build -f .docker/Dockerfile.services --build-arg SERVICE_NAME=job-service -t $REGISTRY/job-service:$IMAGE_TAG -t $REGISTRY/job-service:latest .
          docker push $REGISTRY/job-service:$IMAGE_TAG
          docker push $REGISTRY/job-service:latest

      - name: Build and Push Interview Service
        run: |
          docker build -f .docker/Dockerfile.services --build-arg SERVICE_NAME=interview-service -t $REGISTRY/interview-service:$IMAGE_TAG -t $REGISTRY/interview-service:latest .
          docker push $REGISTRY/interview-service:$IMAGE_TAG
          docker push $REGISTRY/interview-service:latest

      - name: Build and Push Application Service
        run: |
          docker build -f .docker/Dockerfile.services --build-arg SERVICE_NAME=application-service -t $REGISTRY/application-service:$IMAGE_TAG -t $REGISTRY/application-service:latest .
          docker push $REGISTRY/application-service:$IMAGE_TAG
          docker push $REGISTRY/application-service:latest

      - name: Build and Push Rate Analysis Service
        run: |
          docker build -f .docker/Dockerfile.services --build-arg SERVICE_NAME=rate-analysis-service -t $REGISTRY/rate-analysis-service:$IMAGE_TAG -t $REGISTRY/rate-analysis-service:latest .
          docker push $REGISTRY/rate-analysis-service:$IMAGE_TAG
          docker push $REGISTRY/rate-analysis-service:latest

      - name: Upload Infrastructure Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: infra
          path: infra/

      - name: Upload Database Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: database
          path: database/
